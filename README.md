# api-skyline-ts
###### åŸºäº TypeScript å’Œ Node.js çš„ API å¼€å‘çš„è„šæ‰‹æ¶ã€‚

## APIæ“ä½œèµ„æºçš„æœ‰é™æ­¥éª¤
#### â‘  HTTP æ–¹æ³•ï¼šGET, POST, PUT, DELETE, PATCH, HEAD, OPTIONS
- ###### GETã€PUTã€DELETEã€HEAD æ˜¯å¹‚ç­‰çš„ï¼ŒæœåŠ¡å™¨è¦ç¡®ä¿åŒæ ·çš„è¯·æ±‚ï¼Œæ‰§è¡Œä¸€æ¬¡æˆ–å¤šæ¬¡çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚
- ###### POSTã€PATCH æ˜¯éå¹‚ç­‰çš„ï¼ŒæœåŠ¡å™¨ä¸éœ€è¦ç¡®ä¿åŒæ ·çš„è¯·æ±‚ï¼Œæ‰§è¡Œä¸€æ¬¡æˆ–å¤šæ¬¡çš„æ•ˆæœä¸€æ ·ã€‚
- ###### å…¶ä¸­ POST æ˜¯æ–°å¢èµ„æºï¼›PATCH æ˜¯æ›´æ–°èµ„æºçš„éƒ¨åˆ†å†…å®¹ï¼›PUT æ˜¯æ›´æ–°æ•´ä¸ªèµ„æº(ç”¨åœ¨éŸ³è§†é¢‘ç­‰èµ„æºæ¯”è¾ƒåˆé€‚ï¼‰ã€‚

```JS
GET 	/device-management/devices      : Get all devices
GET 	/device-management/devices/{id} : Get the device information identified by "id"

POST 	/device-management/devices      : Create a new device
DELETE	/device-management/devices/{id} : Delete device by "id"

PUT 	/device-management/devices/{id} : Update the device identified by "id"
PATCH 	/device-management/devices/{id} : Update the device information identified by "id"
```


#### â‘¡ HTTP å¤´éƒ¨ä¿¡æ¯
```JS
ã€Accept         ã€‘ç”¨æˆ·ä»£ç†æœŸæœ›çš„ MIMEç±»å‹åˆ—è¡¨ï¼›
ã€Accept-Encodingã€‘ç”¨æˆ·ä»£ç†æ”¯æŒçš„å‹ç¼©ç®—æ³•ï¼›
ã€Authorization  ã€‘ç”¨æˆ·èº«ä»½æ ¡éªŒçš„å‡­è¯ä¿¡æ¯ï¼›

ã€Content-Length ã€‘æ•°æ®ä½“å¤§å°ï¼›
ã€Content-Type   ã€‘æ•°æ®ä½“çš„ MIMEç±»å‹ï¼›

ã€Cookie         ã€‘å­˜å‚¨åœ¨å®¢æˆ·ç«¯çš„çŠ¶æ€ä¿¡æ¯ï¼›
ã€Etag           ã€‘æœåŠ¡ç«¯è¿”å›çš„æ•°æ®æ•£åˆ—å€¼ï¼›
ã€If-None-Match  ã€‘å®¢æˆ·ç«¯æä¾›ç»™æœåŠ¡ç«¯æ ¡éªŒçš„æ•°æ®æ•£åˆ—å€¼ï¼Œåˆ¤æ–­å®¢æˆ·ç«¯çš„æ•°æ®ç¼“å­˜æ˜¯å¦ä»ç„¶æœ‰æ•ˆï¼›
```
[æ›´å¤šä¿¡æ¯](https://en.wikipedia.org/wiki/List_of_HTTP_header_fields)

#### â‘¢ HTTP å“åº”çŠ¶æ€ç 

```JavaScript
200ã€OKã€‘è¯·æ±‚æˆåŠŸå®Œæˆã€‚

201ã€Createdã€‘æ–°å»ºèµ„æºæˆåŠŸã€‚ä¾‹å¦‚ï¼ŒPOST æ–°å»ºèµ„æºæˆåŠŸè¿”å›ã€‚

202ã€Acceptedã€‘å·²æ¥å—è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œä½†å¤„ç†å°šæœªå®Œæˆã€‚

204ã€No Contentã€‘è¡¨ç¤ºæœåŠ¡å™¨å·²ç»æˆåŠŸåœ°æ»¡è¶³äº†è¯·æ±‚ï¼Œå“åº”æœ‰æ•ˆè´Ÿè½½ä½“ä¸­æ²¡æœ‰è¦å‘é€çš„å†…å®¹ã€‚

304ã€Not Modifiedã€‘æ²¡æœ‰æœ€æ–°å†…å®¹ï¼Œå®¢æˆ·ç«¯ä»ç„¶å¯ä»¥ä½¿ç”¨æœ¬åœ°ç¼“å­˜ã€‚

400ã€Bad Requestã€‘è¯·æ±‚æ— æ•ˆã€‚

401ã€Unauthorizedã€‘è¯·æ±‚ä¸åŒ…å«èº«ä»½éªŒè¯ä»¤ç‰Œæˆ–èº«ä»½éªŒè¯ä»¤ç‰Œå·²è¿‡æœŸã€‚

403ã€Forbiddenã€‘å®¢æˆ·ç«¯æ²¡æœ‰è®¿é—®æ‰€è¯·æ±‚èµ„æºçš„æƒé™ã€‚ä¾‹å¦‚ï¼Œè¶…çº§ç®¡ç†å‘˜ã€VIPç”¨æˆ·ã€æ™®é€šç”¨æˆ·ç­‰ã€‚

404ã€Not Foundã€‘æœªæ‰¾åˆ°è¯·æ±‚çš„èµ„æºã€‚ä¾‹å¦‚ï¼Œæ–‡ç« è¢«åˆ é™¤äº†ï¼ŒæŸ¥æ‰¾çš„æ—¶å€™è¿”å›æœªæ‰¾åˆ°æ–‡ç« èµ„æºã€‚

405ã€Method Not Allowedã€‘è¯¥èµ„æºä¸æ”¯æŒè¯·æ±‚ä¸­çš„HTTPæ–¹æ³•ã€‚ä¾‹å¦‚ï¼ŒDELETEæ–¹æ³•ä¸èƒ½ä¸ä»£ç†APIä¸€èµ·ä½¿ç”¨ã€‚

409ã€Conflictã€‘ç”±äºå†²çªï¼Œè¯·æ±‚æ— æ³•å®Œæˆã€‚ä¾‹å¦‚é˜²æŠ–èŠ‚æµï¼Œé‡å¤å‘é€éªŒè¯ç è¢«æ‹’ç»ã€é‡å¤æäº¤ç›¸åŒå†…å®¹ã€‚

500ã€Internal Server Errorã€‘ç”±äºæœåŠ¡å™¨ç«¯çš„å†…éƒ¨é”™è¯¯ï¼Œè¯·æ±‚æœªå®Œæˆã€‚

503ã€Service Unavailableã€‘æœåŠ¡å™¨ä¸å¯ç”¨ã€‚
```

#### â‘£ ä¸€å¥—æ ‡å‡†çš„å†…å®¹åå•†æœºåˆ¶
###### è¿”å›çš„JSON æ•°æ®æ ¼å¼
```JS
const result = {
  code: 0, // ä¸šåŠ¡ç»†èŠ‚å¤„ç†ç»“æœçš„ codeã€‚
  msg: 'ok', // å¯¹ code çš„æè¿°æˆ–è§£é‡Šã€‚
  data: data, // å¦‚æœè¯·æ±‚çš„æ˜¯å¤šä¸ªèµ„æºï¼Œdataä¸ºæ•°ç»„ï¼›å¦‚æœæ˜¯å•ä¸ªèµ„æºï¼Œdataä¸ºå­—å…¸ã€‚
}
// è¡¥å……
- HTTP çŠ¶æ€ç ä¸»è¦é’ˆå¯¹çš„æ˜¯APIæ“ä½œç»“æœï¼Œå¯ä»¥è®©å®¢æˆ·ç«¯è¿›è¡Œå“åº”æ“ä½œï¼›
- å¦‚ï¼ŒTokenè¿‡æœŸï¼Œå¯ä»¥è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œæƒé™ä¸å¤Ÿå¯ä»¥è®©ç”¨æˆ·å»å‡çº§VIP ç­‰ï¼›
- JSON é‡Œçš„ code é’ˆå¯¹çš„æ˜¯å…·ä½“ä¸šåŠ¡çš„æ“ä½œç»“æœï¼Œä¸€èˆ¬å¼¹ä¸ªæ¶ˆæ¯æç¤ºï¼›
- å¯ä»¥ç”¨ 0 è¡¨ç¤ºæˆåŠŸçš„æ“ä½œï¼Œå…¶ä»–é”™è¯¯æŒ‰ä¸šåŠ¡åˆ†ç±»ï¼ŒAä¸šåŠ¡ 10000ï¼ŒBä¸šåŠ¡ 20000 ç­‰ï¼›
- å¦‚ï¼Œä¸‹å•æˆåŠŸ 0ï¼Œä¸‹å•å¤±è´¥ 10000ï¼Œåº“å­˜ä¸è¶³ 10001ï¼Œæ´»åŠ¨ç»“æŸ 10002 ç­‰ï¼›

```
- [å®¢æˆ·ç«¯éœ€è¦ä¸€ä¸ªæŠ½è±¡å±‚å»å¤„ç†è¿™äº›ç»“æ„ç»Ÿä¸€çš„æ•°æ®ã€‚](https://github.com/JohnnyB0Y/api_skyline/blob/main/demo/lib/network_request/demo_service.dart)

#### â‘¤ ä¸€å¥—æ ‡å‡†çš„ç¼“å­˜æœºåˆ¶
###### çŠ¶æ€ç¼“å­˜ - ä¼šè¯
```JS
// å¸¸ç”¨åº“
const session = require('koa-generic-session');
// æç¤º
- éœ€è¦å’Œæ•°æ®åº“ä¸€èµ·ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼ŒRedisã€MongoDB ç­‰ï¼›
- Session å’Œ Token å¾ˆåƒï¼Œä½† Token ä¸éœ€è¦å­˜å‚¨è€Œéœ€è¦å®æ—¶è§£å¯†ã€‚session æ›´åƒæ˜¯ç”¨ç©ºé—´æ¢æ—¶é—´ï¼›
- Cookie å­˜æ”¾åœ¨å®¢æˆ·ç«¯ï¼Œsession å­˜æ”¾åœ¨æœåŠ¡ç«¯ã€‚
```

###### æ•°æ®ç¼“å­˜ - ETag
```JS
// å¸¸ç”¨åº“
const conditional = require('koa-conditional-get');
const etag = require('koa-etag');
// è¡¥å……
- conditional å’Œ etag ä¸€èµ·ä½¿ç”¨ï¼›
// æµç¨‹
- å®¢æˆ·ç«¯å‘æœåŠ¡å™¨è¯·æ±‚èµ„æºï¼Œè¯·æ±‚å¤´å¸¦ä¸ŠIf-None-Match: "6d82cb..."(å¦‚æœæœ‰çš„è¯)ï¼›
- æœåŠ¡ç«¯å–å‡ºIf-None-Match è¿›è¡Œæ¯”è¾ƒï¼›
- æ— ä¿®æ”¹è¿”å› 304çŠ¶æ€ç ï¼Œå¸¦ä¸ŠETag: "6d82cb..."ï¼Œæ— æ•°æ®ä½“ï¼›
- æœ‰ä¿®æ”¹è¿”å› 200çŠ¶æ€ç ï¼Œæ›´æ–°ETag: "89dls2..."ï¼Œå®Œæ•´çš„æ•°æ®ä½“ï¼›
- å®¢æˆ·ç«¯æ”¶åˆ° 304çŠ¶æ€ç ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®ï¼›
- å®¢æˆ·ç«¯æ”¶åˆ° 200çŠ¶æ€ç ï¼Œè§£æä½¿ç”¨æ–°æ•°æ®ï¼›å¹¶æ›´æ–°ç¼“å­˜ä¿¡æ¯ï¼›
```

#### â‘¥ ä¸€å¥—æ ‡å‡†çš„å®¢æˆ·ç«¯èº«ä»½è®¤è¯æœºåˆ¶
###### å®‰å…¨æ€§åŸåˆ™
- æœ‰è°ƒç”¨è€…èº«ä»½ğŸ†”
- è¯·æ±‚å…·æœ‰å”¯ä¸€æ€§
- è¯·æ±‚å‚æ•°ä¸èƒ½è¢«ç¯¡æ”¹
- è¯·æ±‚æœ‰æ•ˆæ—¶é—´

###### ç”¨æˆ·èº«ä»½éªŒè¯
- JWT
```JS
// å¸¸ç”¨çš„åº“
const jwt = require('jsonwebtoken');
const jwt = require('koa-jwt');
// æµç¨‹
- å®¢æˆ·ç«¯å‘æœåŠ¡ç«¯ç”³è¯·ä»¤ç‰Œï¼›
- æœåŠ¡ç«¯æŠŠç”¨æˆ·çš„å¿…è¦ä¿¡æ¯ã€ç§˜é’¥ã€æ—¶é—´ç­‰ï¼Œé€šè¿‡ jwt è¿›è¡Œç­¾åï¼Œå¹¶å°†ç­¾åç»“æœè¿”å›å®¢æˆ·ç«¯ï¼›
- å®¢æˆ·ç«¯å‘èµ·APIæ—¶ï¼Œæºå¸¦ä»¤ç‰Œï¼›
- æœåŠ¡ç«¯é€šè¿‡ jwt éªŒè¯ä»¤ç‰Œé€šè¿‡åï¼Œè¿”å›æ•°æ®ã€‚
```

- OAuth
```JS
// å¸¸ç”¨çš„åº“
const oauth = require('oauth2-server')
// æµç¨‹
- å®¢æˆ·ç«¯å‘ç”¨æˆ·æå‡ºæˆæƒè¯·æ±‚ï¼›
- ç”¨æˆ·åŒæ„å®¢æˆ·ç«¯çš„æˆæƒè¯·æ±‚ï¼›
- å®¢æˆ·ç«¯ä½¿ç”¨ç”¨æˆ·çš„æˆæƒï¼Œå‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼›
- è®¤è¯æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯è¿›è¡Œè®¤è¯ï¼Œå¦‚æ— æ„å¤–ï¼ŒåŒæ„å‘æ”¾ä»¤ç‰Œï¼›
- å®¢æˆ·ç«¯ä½¿ç”¨ä»¤ç‰Œå‘èµ„æºæœåŠ¡å™¨è¯·æ±‚èµ„æºï¼›
- èµ„æºæœåŠ¡å™¨éªŒè¯ä»¤ç‰Œåˆæ³•ï¼ŒåŒæ„å‘å®¢æˆ·ç«¯å¼€æ”¾èµ„æºã€‚
```

###### API è®¿é—®æƒé™
- Scope
```JS
// è¡¥å……
- è®¿é—®çº§åˆ«å¯èƒ½æœ‰ï¼šæ¸¸å®¢ã€æ™®é€šç”¨æˆ·ã€ç®¡ç†å‘˜ã€è¶…çº§ç®¡ç†å‘˜ç­‰ï¼›
- ç”¨æˆ·è¡¨æœ‰ä¸€ä¸ª auth å­—æ®µï¼Œè¡¨æ˜ç”¨æˆ·è´¦å·çº§åˆ«ï¼›
- æ¯ä¸ªAPI é’ˆå¯¹ä¸åŒçš„ auth çº§åˆ«ï¼Œè¿›è¡Œè®¿é—®æ§åˆ¶ï¼›
- å¯ä»¥ç”¨æ•°æ®åº“è®°å½•ã€ç”¨ä¸€ä¸ªScopeç±»é›†ä¸­å¤„ç† æˆ– ç¦»æ•£åˆ°æ¯ä¸ª APIæ§åˆ¶å™¨ä¸­ã€‚
```

###### API è®¿é—®é¢‘ç‡
- Redis
```JS
// å¸¸ç”¨åº“
const ratelimit = require('koa-ratelimit');
const redis = require('redis');
// è¡¥å……
- é˜²æ­¢ç”¨æˆ·ç™»å½•çš„é¢‘ç‡ï¼Œè´¦å·å®‰å…¨é—®é¢˜ï¼›
- æ‰‹æœºéªŒè¯ç å‘é€é¢‘ç‡ï¼Œé™ä½æˆæœ¬é—®é¢˜ï¼›
```

## NodeJS Tips
```JS
1ï¼Œè®¾è®¡å‡½æ•°APIï¼Œä¸è¦è®©å…¶åœ¨æŸç§æ¡ä»¶ä¸‹å¼‚æ­¥æ‰§è¡Œï¼Œå…¶ä»–æ¡ä»¶ä¸‹åŒæ­¥æ‰§è¡Œã€‚
- å…³é”®åœ¨äºï¼Œè¿™ç§å‡½æ•°åŒ…å«ä¸å¯é¢„æµ‹æ€§ï¼Œä¸Šå±‚è°ƒç”¨è€…æ— æ³•æ­£ç¡®çš„å¤„ç†å„ç§æƒ…å†µã€‚
- å¯ä»¥é€šè¿‡æŠŠå‡½æ•°å†…å¼‚æ­¥æ‰§è¡Œçš„ä»£ç è½¬æ¢æˆåŒæ­¥æ‰§è¡Œï¼Œè®©å‡½æ•°å˜æˆåŒæ­¥å‡½æ•°ã€‚
- ä¹Ÿå¯ä»¥é€šè¿‡ä½¿ç”¨ process.nextTick() è®©åŒæ­¥ä»£ç å»¶è¿Ÿæ‰§è¡Œä»¥å®ç°å¼‚æ­¥æ‰§è¡Œå›è°ƒï¼Œè®©å‡½æ•°å˜æˆå¼‚æ­¥å‡½æ•°ã€‚

2ï¼Œå›è°ƒå‡½æ•°ç½®å°¾
- fs.readFile(filename, [options], callback)

3ï¼Œæš´éœ²é”™è¯¯ä¼˜å…ˆ
- NodeJS æ€»æ˜¯æŠŠå‡½æ•°äº§ç”Ÿçš„ä»»ä½•é”™è¯¯ä½œä¸ºå›è°ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ï¼Œä¸”ç±»å‹å§‹ç»ˆä¸º Errorç±»å‹ã€‚
- å¦‚æœæ“ä½œæˆåŠŸï¼Œç¬¬ä¸€ä¸ªå‚æ•°å°†ä¸º null æˆ– undefined ã€‚
fs.readFile('LA.txt', 'utf8', (err, data) => {
  if (err)
    handleError(err)
  else
    processData(data)
})

4ï¼Œåœ¨å¼‚æ­¥å‡½æ•°ä¸­ï¼Œç”¨ä¼ é€’é”™è¯¯æ›¿ä»£æŠ›å¼‚å¸¸ã€‚
- åœ¨åŒæ­¥å‡½æ•°ï¼Œä½¿ç”¨æŠ›å¼‚å¸¸æ¥ä¼ é€’é”™è¯¯ã€‚é”™è¯¯ä¼šåœ¨è°ƒç”¨æ ˆä¸­è·³è½¬ï¼Œç›´åˆ°å®ƒè¢«æ•è·ã€‚
- è€Œåœ¨å¼‚æ­¥å‡½æ•°ï¼Œå›è°ƒä»£ç æ²¡æœ‰ try{}catch(e){} çš„æƒ…å†µä¸‹ï¼Œå¦‚æœå‡ºç°å¼‚å¸¸ï¼Œå°†ä¼šä¸­æ–­å½“å‰ä»£ç çš„æ‰§è¡Œã€‚
- å¹¶ä¸”æ§åˆ¶æƒå°†è¢«ä¼ é€’åˆ°è°ƒç”¨å †æ ˆçš„ç¬¬ä¸€ä¸ªcatchå—ï¼Œæ­¤æ—¶ä¼šå‘å‡º 'uncaughtException' äº‹ä»¶ã€‚
- å› æ­¤ï¼Œåœ¨å¼‚æ­¥å›è°ƒä»£ç ä¸­ï¼ŒæŠŠå¯èƒ½å‡ºé”™çš„ä»£ç ç”¨catchå—åŒ…è£¹ï¼Œå‡ºç°é”™è¯¯å°±ä¼ é€’å‡ºå»ã€‚ï¼ˆå‚è€ƒç¬¬3æ¡ï¼‰

5ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡æœ‰å¤ªå¤šçŠ¶æ€å˜åŒ–æˆ–æ“ä½œäº‹ä»¶éœ€è¦ä¼ é€’ç»™å¤–ç•Œï¼Œé‚£ä¹ˆå°±è®©è¯¥å¯¹è±¡å¯è§‚å¯Ÿã€‚
- è€Œè®©ä¸€ä¸ªå¯¹è±¡å¯è§‚å¯Ÿçš„æœ€å¥½æ–¹æ³•ï¼Œå°±æ˜¯è®©å…¶ç»§æ‰¿è‡ª EventEmitterå¯¹è±¡ã€‚
- å½“å¯¹è±¡å†…éƒ¨å‘å°„äº‹ä»¶æ—¶ï¼Œåº”è€ƒè™‘å¤–ç•Œèƒ½å¦åœ¨äº‹ä»¶å‘å°„å‰æ³¨å†Œç›‘å¬å™¨ã€‚

```

## JavaScript Tips
```JS
1ï¼Œç”¨ for (variable in object) è¯­å¥ä»¥ä»»æ„é¡ºåºéå†ä¸€ä¸ªå¯¹è±¡çš„ï¼ˆé™¤Symbolä»¥å¤–çš„ï¼‰å¯æšä¸¾å±æ€§ã€‚

2ï¼Œç”¨ for (variable of iterable) è¯­å¥éå†è¿­ä»£å¯¹è±¡ï¼ˆArrayï¼ŒMapï¼ŒSetï¼ŒStringï¼ŒTypedArrayï¼Œarguments ç­‰ï¼‰ã€‚

```

## å‚è€ƒèµ„æ–™
##### é¡¹ç›®é…ç½®
[Node.js and TypeScript Tutorial: Build a CRUD API](https://auth0.com/blog/node-js-and-typescript-tutorial-build-a-crud-api/)

[TypeScript-Node-Starter](https://github.com/microsoft/TypeScript-Node-Starter)

##### æ•°æ®åº“
[Node-orm2: Object Relational Mapping](https://github.com/dresende/node-orm2)

##### ç¼“å­˜
[Caching with Entity Tags](https://www.w3.org/2005/MWI/BPWG/techs/CachingWithETag.html)

[If-None-Match](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/If-None-Match#browser_compatibility)

##### HTTP
[HTTP å“åº”ä»£ç ](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status)

[HTTP Status](https://restfulapi.net/tutorial/http-status/)

[HTTP æƒå¨æŒ‡å—-æç‚¼ç‰ˆ](https://github.com/woai30231/http)

##### æ–‡æ¡£
[Node.js v15.12.0 Documentation](https://nodejs.org/api/errors.html)

[JSè¯­å¥å’Œå£°æ˜](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements)